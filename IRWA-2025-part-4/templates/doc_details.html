{% extends "base.html" %}
{% block page_title %}{{ page_title }}{% endblock %}
{% block content %}
    
    <h3>Document: {{ doc_id }}</h3>
    <script>
        // 1. Capture Start Time
        let startTime = Date.now();
        let eventId = {{ event_id }}; // Passed from Flask

        // 2. Function to send the duration
        function sendDwellTime() {
            let endTime = Date.now();
            let duration = (endTime - startTime) / 1000; // Convert ms to seconds

            let data = JSON.stringify({
                event_id: eventId,
                dwell_time: duration
            });

            // navigator.sendBeacon is reliable for "page close" events
            if (navigator.sendBeacon) {
                let blob = new Blob([data], {type: 'application/json'});
                navigator.sendBeacon('/log_dwell_time', blob);
            } else {
                fetch('/log_dwell_time', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: data,
                    keepalive: true
                });
            }
        }

        // 3. Trigger when user leaves the page (close tab, back button, reload)
        window.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                sendDwellTime();
            }
        });
    </script>
{% endblock %}
